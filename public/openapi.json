{
  "openapi": "3.0.3",
  "info": {
    "title": "QuickDCP API",
    "version": "1.0.0",
    "description": "QuickDCP API for upload, job orchestration, proof chain, and verification."
  },
  "servers": [
    {
      "url": "http://localhost:8080",
      "description": "Local dev"
    }
  ],
  "components": {
    "securitySchemes": {
      "ApiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "X-API-Key"
      }
    },
    "schemas": {
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "code": { "type": "string" },
          "message": { "type": "string" },
          "details": { "type": "object", "nullable": true }
        },
        "required": ["code", "message"]
      },
      "Job": {
        "type": "object",
        "properties": {
          "job_id": { "type": "string" },
          "status": { "type": "string" },
          "profile": { "type": "object" },
          "manifest": { "type": "object" }
        },
        "required": ["job_id", "status"]
      },
      "JobCreateRequest": {
        "type": "object",
        "properties": {
          "customer_code": { "type": "string" },
          "profile": { "type": "object" }
        },
        "required": ["customer_code", "profile"]
      },
      "JobStatusResponse": {
        "allOf": [
          { "$ref": "#/components/schemas/Job" }
        ]
      },
      "ProofInitRequest": {
        "type": "object",
        "properties": {
          "job_id": { "type": "string" },
          "manifest_sha256": { "type": "string" }
        },
        "required": ["job_id", "manifest_sha256"]
      },
      "ProofAckTsaRequest": {
        "type": "object",
        "properties": {
          "job_id": { "type": "string" },
          "tsr": {
            "type": "string",
            "description": "Base64-encoded TSA response"
          }
        },
        "required": ["job_id", "tsr"]
      },
      "VerifyResponse": {
        "type": "object",
        "properties": {
          "ok": { "type": "boolean" },
          "job_id": { "type": "string" },
          "status": { "type": "string" },
          "manifest": { "type": "object" },
          "proof": { "type": "object" }
        },
        "required": ["ok"]
      }
    }
  },
  "security": [
    { "ApiKeyAuth": [] }
  ],
  "paths": {
    "/healthz": {
      "get": {
        "summary": "Health check",
        "responses": {
          "200": {
            "description": "Service healthy",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "ok": { "type": "boolean" },
                    "db": { "type": "string" }
                  },
                  "required": ["ok"]
                }
              }
            }
          }
        }
      }
    },
    "/upload/init": {
      "post": {
        "summary": "Init multipart upload",
        "security": [{ "ApiKeyAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/x-www-form-urlencoded": {
              "schema": {
                "type": "object",
                "properties": {
                  "filename": { "type": "string" },
                  "size": { "type": "integer" },
                  "sha256": { "type": "string" }
                },
                "required": ["filename", "size", "sha256"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Upload initialized",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "upload_id": { "type": "string" },
                    "key": { "type": "string" }
                  },
                  "required": ["upload_id", "key"]
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      }
    },
    "/upload/part": {
      "post": {
        "summary": "Sign upload part",
        "security": [{ "ApiKeyAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/x-www-form-urlencoded": {
              "schema": {
                "type": "object",
                "properties": {
                  "key": { "type": "string" },
                  "upload_id": { "type": "string" },
                  "part_number": { "type": "integer" }
                },
                "required": ["key", "upload_id", "part_number"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Presigned URL returned",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "url": { "type": "string" }
                  },
                  "required": ["url"]
                }
              }
            }
          }
        }
      }
    },
    "/upload/complete": {
      "post": {
        "summary": "Complete multipart upload",
        "security": [{ "ApiKeyAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "key": { "type": "string" },
                  "upload_id": { "type": "string" },
                  "parts": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "properties": {
                        "etag": { "type": "string" },
                        "part_number": { "type": "integer" }
                      },
                      "required": ["etag", "part_number"]
                    }
                  }
                },
                "required": ["key", "upload_id", "parts"]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Upload completed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "key": { "type": "string" },
                    "size": { "type": "integer" }
                  },
                  "required": ["key"]
                }
              }
            }
          }
        }
      }
    },
    "/jobs/render": {
      "post": {
        "summary": "Enqueue render job",
        "security": [{ "ApiKeyAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/JobCreateRequest" }
            }
          }
        },
        "responses": {
          "202": {
            "description": "Job accepted",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/Job" }
              }
            }
          },
          "402": {
            "description": "Limit exceeded / cost guard",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      }
    },
    "/jobs/{job_id}": {
      "get": {
        "summary": "Get job status",
        "security": [{ "ApiKeyAuth": [] }],
        "parameters": [
          {
            "name": "job_id",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Job status",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/JobStatusResponse" }
              }
            }
          },
          "404": {
            "description": "Job not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      }
    },
    "/proof/init": {
      "post": {
        "summary": "Create TSQ for proof",
        "security": [{ "ApiKeyAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/ProofInitRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "TSQ created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "job_id": { "type": "string" },
                    "tsq": {
                      "type": "string",
                      "description": "Base64-encoded TSQ"
                    }
                  },
                  "required": ["job_id", "tsq"]
                }
              }
            }
          }
        }
      }
    },
    "/proof/ack/tsa": {
      "post": {
        "summary": "Verify TSA response and finalize proof",
        "security": [{ "ApiKeyAuth": [] }],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/ProofAckTsaRequest" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Proof accepted",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "job_id": { "type": "string" },
                    "status": { "type": "string" },
                    "tsa_time": {
                      "type": "string",
                      "format": "date-time"
                    }
                  },
                  "required": ["job_id", "status"]
                }
              }
            }
          }
        }
      }
    },
    "/verify/{ref}": {
      "get": {
        "summary": "Verify proof by reference",
        "parameters": [
          {
            "name": "ref",
            "in": "path",
            "required": true,
            "schema": { "type": "string" }
          }
        ],
        "responses": {
          "200": {
            "description": "Verification response",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/VerifyResponse" }
              }
            }
          },
          "404": {
            "description": "Not found",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/ErrorResponse" }
              }
            }
          }
        }
      }
    }
  }
}
