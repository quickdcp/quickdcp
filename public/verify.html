<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <title>QuickDCP — Verify Proof</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Public verification for QuickDCP TSA proof records" />

  <style>
    :root {
      --bg: #030712;
      --bg-elevated: #050816;
      --bg-elevated-soft: #070b1c;
      --border-subtle: rgba(148, 163, 184, 0.08);
      --border-strong: rgba(56, 189, 248, 0.8);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --text-muted: #6b7280;
      --accent-cyan: #22d3ee;
      --accent-green: #4ade80;
      --accent-amber: #fbbf24;
      --accent-red: #f97373;
      --chip-bg: rgba(15, 23, 42, 0.9);
      --chip-border: rgba(148, 163, 184, 0.4);
      --shadow-soft: 0 22px 60px rgba(15, 23, 42, 0.9);
      --radius-xl: 26px;
      --radius-lg: 18px;
      --radius-pill: 999px;
      --transition-fast: 140ms ease-out;
      --transition-slow: 260ms ease-out;
      /* Legacy variable mappings for backward compatibility */
      --fg: var(--text-main);
      --muted: var(--text-soft);
      --card: var(--bg-elevated);
      --card-border: var(--border-subtle);
      --accent: var(--accent-cyan);
      --accent2: var(--accent-green);
      --gold: var(--accent-amber);
      --ok: var(--accent-green);
      --warn: var(--accent-amber);
      --err: var(--accent-red);
      --shadow: var(--shadow-soft);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "SF Pro Display", -apple-system, BlinkMacSystemFont, Inter, Roboto,
        Helvetica, Arial, sans-serif;
      background: radial-gradient(circle at top, #020617 0, #000 60%);
      color: var(--text-main);
      overflow-x: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image: radial-gradient(
          circle at 10% -10%,
          rgba(56, 189, 248, 0.25),
          transparent 55%
        ),
        radial-gradient(
          circle at 90% 0%,
          rgba(59, 130, 246, 0.24),
          transparent 55%
        );
      opacity: 0.8;
      mix-blend-mode: screen;
      pointer-events: none;
      z-index: -3;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background-image: radial-gradient(
          circle at 20% 120%,
          rgba(16, 185, 129, 0.2),
          transparent 55%
        ),
        radial-gradient(
          circle at 80% 120%,
          rgba(129, 140, 248, 0.25),
          transparent 55%
        );
      opacity: 0.6;
      mix-blend-mode: screen;
      pointer-events: none;
      z-index: -3;
    }

    .bg-texture {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.18;
      background-image: linear-gradient(
          90deg,
          rgba(148, 163, 184, 0.12) 1px,
          transparent 1px
        ),
        linear-gradient(
          180deg,
          rgba(148, 163, 184, 0.12) 1px,
          transparent 1px
        );
      background-size: 80px 80px;
      mask-image: radial-gradient(circle at 15% 20%, #000 0, transparent 60%);
      z-index: -2;
    }


    header {
      position:sticky;
      top:0;
      z-index:1000;
      backdrop-filter:blur(20px);
      background:linear-gradient(
          to bottom,
          rgba(15, 23, 42, 0.92),
          rgba(15, 23, 42, 0.9),
          rgba(15, 23, 42, 0.7),
          transparent
        ),
        radial-gradient(circle at top left, rgba(59, 130, 246, 0.2), transparent 55%);
      border-bottom:1px solid rgba(148, 163, 184, 0.18);
      box-shadow:0 2px 8px rgba(0, 0, 0, 0.15);
    }
    .header-inner {
      max-width:1320px;
      margin:0 auto;
      padding:18px 32px 14px;
      display:flex;
      align-items:center;
      gap:20px;
    }
    @media (max-width: 960px) {
      .header-inner {
        flex-direction:column;
        align-items:flex-start;
        padding:14px 18px 10px;
        gap:12px;
      }
    }
    .brand {
      display:flex;
      align-items:center;
      gap:16px;
    }
    .brand-logo {
      width:46px;
      height:46px;
      border-radius:999px;
      background:radial-gradient(circle at 30% 0, #ffffff, #e5e7eb 24%, #000 100%);
      box-shadow:0 0 0 1px rgba(15, 23, 42, 0.9),
        0 0 0 4px rgba(30, 64, 175, 0.8),
        0 0 40px rgba(56, 189, 248, 0.9);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .brand-logo img {
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:inherit;
    }
    .brand-text {
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-title {
      font-size:20px;
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .brand-subtitle {
      font-size:12px;
      color:var(--muted);
      letter-spacing:0.08em;
      text-transform:uppercase;
    }
    h1 { margin:0; font-size:24px; color:var(--gold); letter-spacing:0.6px; }
    .sub { font-size:13px; color:var(--muted); }

    .nav-pills {
      display:flex;
      gap:8px;
      padding:0 32px 14px;
      max-width:1320px;
      margin:-4px auto 0;
      flex-wrap:wrap;
    }
    @media (max-width: 960px) {
      .nav-pills {
        padding:0 18px 14px;
      }
    }
    .nav-pill {
      font-size:12px;
      border-radius:999px;
      padding:6px 14px;
      border:1px solid rgba(148, 163, 184, 0.45);
      background:rgba(15, 23, 42, 0.95);
      color:var(--muted);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      text-decoration:none;
      transition:background 140ms ease-out,
        border-color 140ms ease-out, color 140ms ease-out,
        box-shadow 140ms ease-out, transform 120ms ease-out;
    }
    .nav-pill:hover {
      border-color:rgba(56, 189, 248, 0.9);
      color:#e5e7eb;
      box-shadow:0 0 22px rgba(56, 189, 248, 0.45);
      transform:translateY(-1px);
    }
    .nav-pill.active {
      background:radial-gradient(
          circle at top,
          rgba(34, 211, 238, 0.45),
          rgba(8, 47, 73, 0.95)
        ),
        rgba(0, 0, 0, 0.9);
      border-color:rgba(45, 212, 191, 1);
      color:#f9fafb;
      box-shadow:0 0 24px rgba(34, 211, 238, 0.85);
    }
    .kbd-hint {
      max-width:1320px;
      margin:0 auto;
      padding:0 32px 10px;
      font-size:11px;
      color:var(--muted);
      opacity:0.7;
    }
    @media (max-width: 960px) {
      .kbd-hint {
        padding:0 18px 10px;
      }
    }

    main {
      max-width:960px;
      margin:0 auto;
      padding:26px 18px 72px;
    }

    .card {
      background:var(--card);
      border-radius:20px;
      border:1px solid var(--card-border);
      box-shadow:var(--shadow);
      padding:20px 18px 18px;
      position:relative;
      overflow:hidden;
      margin-bottom:20px;
    }
    .card::before {
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:inherit;
      background:conic-gradient(from 220deg,
        rgba(0,184,255,0.25),
        rgba(0,255,162,0.25),
        rgba(216,177,90,0.25),
        rgba(0,184,255,0.25));
      mix-blend-mode:screen;
      filter:blur(18px);
      opacity:0.12;
      z-index:-1;
    }

    h2 { margin:0 0 10px; font-size:18px; color:var(--gold); }

    .row {
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
    }

    input {
      width:100%;
      padding:11px 12px;
      border-radius:11px;
      border:1px solid rgba(160,200,255,0.3);
      background:rgba(5,10,20,0.96);
      color:var(--fg);
      font-size:14px;
      outline:none;
      transition:border-color 0.2s, box-shadow 0.2s, background 0.2s;
    }
    input:focus {
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(0,184,255,0.5);
      background:rgba(7,12,24,0.98);
    }

    .btn {
      padding:11px 16px;
      border-radius:11px;
      border:none;
      background:linear-gradient(120deg, var(--accent), var(--accent2));
      color:white;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      letter-spacing:0.3px;
      box-shadow:0 10px 28px rgba(0,184,255,0.45);
    }
    .btn:hover { transform:translateY(-1px); box-shadow:0 14px 32px rgba(0,184,255,0.6); }

    .hint { font-size:12px; color:var(--muted); margin-top:6px; }

    .result { margin-top:16px; display:none; }
    .result.show { display:block; }

    .kv { display:grid; grid-template-columns:140px 1fr; gap:8px; align-items:flex-start; font-size:13px; }
    .kv .k { color:var(--muted); }

    .status { font-weight:600; }
    .status.ok { color:var(--ok); }
    .status.pending { color:var(--warn); }
    .status.fail { color:var(--err); }

    code { font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }

    .actions {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
      font-size:12px;
    }
    .pill-action {
      padding:4px 9px;
      border-radius:999px;
      border:1px dashed rgba(160,200,255,0.45);
      color:var(--muted);
      cursor:pointer;
      background:rgba(2,8,18,0.96);
    }
    .pill-action:hover { color:#dde4ff; border-style:solid; }

    pre {
      background:rgba(1,4,10,0.96);
      border-radius:12px;
      border:1px solid rgba(160,200,255,0.22);
      padding:12px;
      font-size:12px;
      overflow:auto;
      color:#e2e7ff;
    }

    .grid {
      display:grid;
      grid-template-columns:minmax(0, 1.3fr) minmax(0, 1fr);
      gap:18px;
    }

    .qrcode {
      display:grid;
      place-items:center;
      padding:10px;
      border-radius:14px;
      border:1px dashed rgba(160,200,255,0.4);
      background:rgba(3,8,18,0.96);
    }

    ul { margin:0; padding-left:18px; font-size:13px; color:var(--muted); }
    li { margin-bottom:4px; }
    .warn-text { color:var(--warn); }

    @media (max-width: 720px) {
      .header-inner { flex-direction:column; align-items:flex-start; }
      .grid { grid-template-columns:1fr; }
      .row { grid-template-columns:1fr; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>
</head>
<body>
<div class="bg-texture"></div>

<header>
  <div class="header-inner">
    <div class="brand">
      <div class="brand-logo">
        <img src="QuickDCP-logo300.png" alt="QuickDCP" />
      </div>
      <div class="brand-text">
        <div class="brand-title">QuickDCP — Verify Proof</div>
        <div class="brand-subtitle">Independent manifest verification</div>
      </div>
    </div>
  </div>
  <div class="nav-pills">
    <a href="/index.html#panel-upload" class="nav-pill">Upload</a>
    <a href="/index.html#panel-jobs" class="nav-pill">Jobs</a>
    <a href="/index.html#panel-qc" class="nav-pill">QC</a>
    <a href="/index.html#panel-proof" class="nav-pill">Proof</a>
    <a href="/index.html#panel-worker" class="nav-pill">Worker</a>
    <a href="/index.html#panel-kdm" class="nav-pill">KDM</a>
    <a href="/index.html#panel-vault" class="nav-pill">Vault</a>
    <a href="/verify.html" class="nav-pill active">Verify</a>
    <a href="/about.html" class="nav-pill">About</a>
  </div>
  <div class="kbd-hint">⌘K / Ctrl+K · Jump to panel (on System Core)</div>
</header>

<main>
  <section class="card">
    <h2>1. Reference</h2>
    <div class="row">
      <input id="ref" placeholder="JOB-123 or 64-char hex manifest sha" autocomplete="on" />
      <button class="btn" id="go">Verify</button>
    </div>
    <div class="hint">Tip: paste a job id like <code>JOB-LOCAL</code> or a hex digest. Append <code>?ref=...</code> to this URL to prefill for festivals.</div>

    <div id="result" class="result">
      <h2 style="margin:18px 0 6px; font-size:16px;">2. Result</h2>
      <div class="kv">
        <div class="k">Status</div>
        <div><span id="status" class="status">—</span></div>
        <div class="k">Job ID</div>
        <div><code id="job"></code></div>
        <div class="k">Manifest SHA-256</div>
        <div><code id="sha"></code></div>
      </div>
      <div class="actions">
        <div class="pill-action" id="copyLink">Copy deep link</div>
        <div class="pill-action" id="copyJSON">Copy JSON</div>
        <div class="pill-action" id="openJobs">Open /jobs</div>
      </div>
    </div>
  </section>

  <section class="grid">
    <div class="card">
      <h2 style="margin-bottom:8px; font-size:16px;">API call</h2>
      <pre><code id="curl">curl -s $API/verify/JOB-123 | jq</code></pre>
      <div class="hint">Share this with a festival or projection partner for independent verification.</div>
    </div>
    <div class="card">
      <h2 style="margin-bottom:8px; font-size:16px;">Share</h2>
      <div class="qrcode">
        <canvas id="qr" width="160" height="160"></canvas>
      </div>
      <div class="hint">Scan to reopen this verification page with the current reference embedded.</div>
    </div>
  </section>

  <section class="card">
    <h2 style="margin-bottom:8px; font-size:16px;">Troubleshooting</h2>
    <ul>
      <li>If you see <span class="warn-text">PENDING</span>, the TSA acknowledgment has not been verified yet.</li>
      <li>If you see <code>NOT_FOUND</code>, the reference is unknown to this QuickDCP node.</li>
      <li>Ensure the server hosting this page can reach <code>/verify/&lt;ref&gt;</code> on the API.</li>
      <li>Manifests may remain locked at <code>/jobs/&lt;job_id&gt;</code> until status becomes VALID.</li>
    </ul>
  </section>
</main>

<script>
  const els = {
    ref: document.getElementById('ref'),
    go: document.getElementById('go'),
    res: document.getElementById('result'),
    status: document.getElementById('status'),
    job: document.getElementById('job'),
    sha: document.getElementById('sha'),
    curl: document.getElementById('curl'),
    qr: document.getElementById('qr'),
    copyLink: document.getElementById('copyLink'),
    copyJSON: document.getElementById('copyJSON'),
    openJobs: document.getElementById('openJobs'),
  };

  function isHex64(s){ return /^[a-fA-F0-9]{64}$/.test((s||'').trim()); }

  function apiBase(){
    const { origin } = window.location;
    return origin;
  }

  function setStatus(txt){
    els.status.textContent = txt;
    els.status.className = 'status';
    if (txt === 'VALID') els.status.classList.add('ok');
    else if (txt === 'ERROR' || txt === 'INVALID') els.status.classList.add('fail');
    else els.status.classList.add('pending');
  }

  function updateCurl(ref){
    const url = apiBase()+"/verify/"+encodeURIComponent(ref);
    els.curl.textContent = `curl -s ${url} | jq`;
  }

  function updateQR(ref){
    const u = new URL(window.location.href);
    u.searchParams.set('ref', ref);
    if (window.QRCode){
      QRCode.toCanvas(els.qr, u.toString(), { width: 160, margin: 1 }, function(){});
    }
  }

  async function verifyRef(){
    const ref = (els.ref.value||'').trim();
    if (!ref) { 
      const toast = document.createElement('div');
      toast.textContent = 'Enter a job ID or manifest hash.';
      toast.style.cssText = 'position:fixed;bottom:32px;left:50%;transform:translateX(-50%);padding:10px 18px;background:rgba(15,23,42,0.98);border:1px solid rgba(56,189,248,0.6);border-radius:999px;color:#e5e7eb;font-size:12px;z-index:2000;';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
      return; 
    }
    try {
      setStatus('…');
      if (els.res) els.res.classList.add('show');
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000);
      
      const res = await fetch(apiBase()+"/verify/"+encodeURIComponent(ref), {
        signal: controller.signal
      });
      
      clearTimeout(timeoutId);
      
      if (!res.ok) {
        let errorMsg = `HTTP ${res.status}: ${res.statusText}`;
        try {
          const errorData = await res.json();
          errorMsg = errorData.message || errorData.error || JSON.stringify(errorData);
        } catch {
          // If JSON parsing fails, use status text
        }
        throw new Error(errorMsg);
      }
      
      let j;
      try {
        j = await res.json();
      } catch (jsonErr) {
        throw new Error('Invalid JSON response from server');
      }
      
      setStatus(j.status || 'PENDING');
      if (els.job) els.job.textContent = j.job_id || '-';
      if (els.sha) els.sha.textContent = j.manifest_sha256 || '-';
      updateCurl(ref);
      updateQR(ref);

      if (els.copyLink) {
        els.copyLink.onclick = async () => {
          try {
            const u = new URL(window.location.href); 
            u.searchParams.set('ref', ref);
            await navigator.clipboard.writeText(u.toString());
            els.copyLink.textContent = 'Copied'; 
            setTimeout(()=>els.copyLink.textContent='Copy deep link',1200);
          } catch (err) {
            console.error('Failed to copy link:', err);
          }
        };
      }
      
      if (els.copyJSON) {
        els.copyJSON.onclick = async () => {
          try {
            await navigator.clipboard.writeText(JSON.stringify(j, null, 2));
            els.copyJSON.textContent = 'Copied'; 
            setTimeout(()=>els.copyJSON.textContent='Copy JSON',1200);
          } catch (err) {
            console.error('Failed to copy JSON:', err);
          }
        };
      }
      
      if (els.openJobs) {
        els.openJobs.onclick = () => {
          const id = j.job_id || ref; 
          if (id) {
            try {
              window.open(apiBase()+"/jobs/"+encodeURIComponent(id), '_blank');
            } catch (err) {
              console.error('Failed to open jobs link:', err);
            }
          }
        };
      }
    } catch (e){
      if (e.name === 'AbortError') {
        setStatus('TIMEOUT');
        if (els.job) els.job.textContent = 'Request timeout';
        if (els.sha) els.sha.textContent = '-';
      } else {
        setStatus('ERROR');
        if (els.job) els.job.textContent = e.message || 'Request failed';
        if (els.sha) els.sha.textContent = '-';
      }
      updateCurl(ref);
      updateQR(ref);
    }
  }

  els.go.addEventListener('click', verifyRef);
  els.ref.addEventListener('keydown', (e)=>{ if (e.key==='Enter') verifyRef(); });

  const q = new URLSearchParams(window.location.search);
  const preset = q.get('ref');
  if (preset){ els.ref.value = preset; verifyRef(); }

  // Highlight active nav pill
  document.querySelectorAll('.nav-pill').forEach(pill => {
    if (pill.getAttribute('href') === window.location.pathname || 
        pill.getAttribute('href') === window.location.pathname + window.location.hash) {
      pill.classList.add('active');
    }
  });
</script>
</body>
</html>